# ๐ณ ะกะธััะตะผะฐ ะกะะ ะะปะฐัะตะถะตะน - Ad Lab

## ๐ ะะฑะทะพั

ะะพะปะฝะพััะฝะบัะธะพะฝะฐะปัะฝะฐั ัะธััะตะผะฐ ะพะฟะปะฐัั ัะตัะตะท ะกะะ (ะกะธััะตะผั ะฑัััััั ะฟะปะฐัะตะถะตะน) ะธะฝัะตะณัะธัะพะฒะฐะฝะฝะฐั ั ะฎKassa. ะกะธััะตะผะฐ ะฟะพะดะดะตัะถะธะฒะฐะตั ัะพะทะดะฐะฝะธะต ะฟะปะฐัะตะถะตะน, ะณะตะฝะตัะฐัะธั QR-ะบะพะดะพะฒ, ะฐะฒัะพะผะฐัะธัะตัะบัั ะพะฑัะฐะฑะพัะบั ััะฐัััะพะฒ ัะตัะตะท ะฒะตะฑััะบะธ ะธ ัะฟัะฐะฒะปะตะฝะธะต ะฟะพะดะฟะธัะบะฐะผะธ.

## โจ ะะพะทะผะพะถะฝะพััะธ

- โ **ะกะพะทะดะฐะฝะธะต ะกะะ ะฟะปะฐัะตะถะตะน** ัะตัะตะท ะฎKassa API
- โ **QR-ะบะพะดั** ะดะปั ะผะณะฝะพะฒะตะฝะฝะพะน ะพะฟะปะฐัั ะฒ ะฑะฐะฝะบะพะฒัะบะธั ะฟัะธะปะพะถะตะฝะธัั
- โ **ะะตะฑััะบะธ** ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะพะฑะฝะพะฒะปะตะฝะธั ััะฐัััะพะฒ ะฟะปะฐัะตะถะตะน
- โ **ะะฐะทะฐ ะดะฐะฝะฝัั** ะดะปั ััะฐะฝะตะฝะธั ะฟะปะฐัะตะถะตะน ะธ ะฟะพะดะฟะธัะพะบ
- โ **ะััะตะฝัะธัะธะบะฐัะธั** ะธ ะฟัะพะฒะตัะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ
- โ **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ** ะธ ะปะพะณะธัะพะฒะฐะฝะธะต
- โ **ะขะตััะธัะพะฒะฐะฝะธะต** ัะธััะตะผั ะฟะปะฐัะตะถะตะน
- โ **ะะพะปัะทะพะฒะฐัะตะปััะบะธะน ะธะฝัะตััะตะนั** ั ะฟะพะดะดะตัะถะบะพะน QR-ะบะพะดะพะฒ

## ๐ ะััะธัะตะบัััะฐ ัะธััะตะผั

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Frontend      โ    โ   Backend API    โ    โ   YooKassa      โ
โ                 โ    โ                  โ    โ                 โ
โ PaywallModal    โโโโโถโ /api/payments/   โโโโโถโ ะกะะ ะฟะปะฐัะตะถะธ     โ
โ QR Scanner      โ    โ sbp              โ    โ QR-ะบะพะดั         โ
โ Status Updates  โ    โ                  โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
                                โ
                                โผ
                       โโโโโโโโโโโโโโโโโโโโ
                       โ   PostgreSQL     โ
                       โ                  โ
                       โ โข payments       โ
                       โ โข subscriptions  โ
                       โ โข users          โ
                       โโโโโโโโโโโโโโโโโโโโ
                                โฒ
                                โ
                       โโโโโโโโโโโโโโโโโโโโ
                       โ   Webhooks       โ
                       โ                  โ
                       โ Auto updates     โ
                       โ Status tracking  โ
                       โโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะกัััะบัััะฐ ัะฐะนะปะพะฒ

```
โโโ app/api/payments/
โ   โโโ sbp/
โ   โ   โโโ route.ts              # API ะดะปั ัะพะทะดะฐะฝะธั/ะฟัะพะฒะตัะบะธ ะกะะ ะฟะปะฐัะตะถะตะน
โ   โโโ webhook/
โ       โโโ route.ts              # ะะตะฑััะบ ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน ะพั ะฎKassa
โโโ components/
โ   โโโ paywall-modal.tsx         # UI ะบะพะผะฟะพะฝะตะฝั ะดะปั ะพะฟะปะฐัั
โโโ lib/
โ   โโโ yookassa-client.ts        # ะะปะธะตะฝั ะดะปั ัะฐะฑะพัั ั ะฎKassa API
โ   โโโ services/
โ   โ   โโโ billing-service.ts    # ะกะตัะฒะธั ะดะปั ัะฐะฑะพัั ั ะฟะปะฐัะตะถะฐะผะธ ะฒ ะะ
โ   โโโ database-schema.sql       # ะกัะตะผะฐ ะฑะฐะทั ะดะฐะฝะฝัั
โ   โโโ database-types.ts         # TypeScript ัะธะฟั ะดะปั ะะ
โโโ scripts/
โ   โโโ test-payment-system.ts    # ะกะบัะธะฟั ะดะปั ัะตััะธัะพะฒะฐะฝะธั ัะธััะตะผั
โโโ PAYMENT_SYSTEM_README.md      # ะะฐะฝะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั
```

## ๐ง ะะฐัััะพะนะบะฐ

### 1. ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะกะพะทะดะฐะนัะต ัะฐะนะป `.env.local` ัะพ ัะปะตะดัััะธะผะธ ะฟะตัะตะผะตะฝะฝัะผะธ:

```bash
# ะฎKassa ะฝะฐัััะพะนะบะธ (ะพะฑัะทะฐัะตะปัะฝะพ)
YOOKASSA_SHOP_ID=your_shop_id_here
YOOKASSA_SECRET_KEY=your_secret_key_here

# ะะฐะทะฐ ะดะฐะฝะฝัั (ะพะฑัะทะฐัะตะปัะฝะพ)
DATABASE_URL=postgresql://user:password@localhost:5432/adlab_db

# JWT ะดะปั ัะตััะธะน (ะพะฑัะทะฐัะตะปัะฝะพ, ะผะธะฝะธะผัะผ 32 ัะธะผะฒะพะปะฐ)
JWT_SECRET=your_super_secret_jwt_key_at_least_32_chars

# URL ะฟัะธะปะพะถะตะฝะธั
NEXTAUTH_URL=http://localhost:3000

# OpenAI (ะดะปั ะพัะฝะพะฒะฝะพะณะพ ััะฝะบัะธะพะฝะฐะปะฐ)
OPENAI_API_KEY=your_openai_api_key_here
```

### 2. ะะฐัััะพะนะบะฐ ะฎKassa

1. ะะฐัะตะณะธัััะธััะนัะตัั ะฝะฐ [yookassa.ru](https://yookassa.ru)
2. ะะพะปััะธัะต `SHOP_ID` ะธ `SECRET_KEY` ะฒ ะปะธัะฝะพะผ ะบะฐะฑะธะฝะตัะต
3. ะะฐัััะพะนัะต webhook URL: `https://your-domain.com/api/payments/webhook`
4. ะะบะปััะธัะต ัะฒะตะดะพะผะปะตะฝะธั ะดะปั ัะพะฑััะธะน:
   - `payment.succeeded`
   - `payment.canceled`
   - `payment.waiting_for_capture`

### 3. ะะฐัััะพะนะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั

```bash
# ะะฝะธัะธะฐะปะธะทะฐัะธั ััะตะผั ะะ
psql -d your_database < lib/database-schema.sql

# ะะปะธ ะธัะฟะพะปัะทัะนัะต ัะบัะธะฟั ะธะฝะธัะธะฐะปะธะทะฐัะธะธ
npm run db:init
```

### 4. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
npm install @a2seven/yoo-checkout
npm install uuid
npm install @types/uuid  # ะตัะปะธ ะธัะฟะพะปัะทัะตัะต TypeScript
```

## ๐ ะะฐะฟััะบ

### ะะฐะทัะฐะฑะพัะบะฐ

```bash
# ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั
npm run dev

# ะขะตััะธัะพะฒะฐะฝะธะต ะฟะปะฐัะตะถะฝะพะน ัะธััะตะผั
npm run test:payments
# ะธะปะธ
npx ts-node scripts/test-payment-system.ts
```

### Production

1. ะฃะฑะตะดะธัะตัั, ััะพ ะฒัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฝะฐัััะพะตะฝั
2. Webhook URL ะดะพะปะถะตะฝ ะฑััั ะดะพัััะฟะตะฝ ะธะทะฒะฝะต
3. ะัะฟะพะปัะทัะนัะต HTTPS ะดะปั ะฑะตะทะพะฟะฐัะฝะพััะธ
4. ะะฐัััะพะนัะต ะผะพะฝะธัะพัะธะฝะณ ะปะพะณะพะฒ ะฟะปะฐัะตะถะตะน

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

ะกะธััะตะผะฐ ะฒะบะปััะฐะตั ะฐะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต:

```bash
# ะะฐะฟััะบ ะฒัะตั ัะตััะพะฒ ะฟะปะฐัะตะถะฝะพะน ัะธััะตะผั
npm run test:payments

# ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ะพัะดะตะปัะฝัั ะบะพะผะฟะพะฝะตะฝัะพะฒ
node -e "
const { testYooKassaConnection } = require('./lib/yookassa-client');
testYooKassaConnection().then(console.log);
"
```

### ะขะตััะพะฒัะต ััะตะฝะฐัะธะธ

1. โ **ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั**
2. โ **ะะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั**
3. โ **ะะพะดะบะปััะตะฝะธะต ะบ ะฎKassa API**
4. โ **ะกะพะทะดะฐะฝะธะต ัะตััะพะฒะพะณะพ ะฟะปะฐัะตะถะฐ**
5. โ **ะะพะปััะตะฝะธะต ััะฐัััะฐ ะฟะปะฐัะตะถะฐ**
6. โ **ะะฐะฑะพัะฐ ั ะฟะพะดะฟะธัะบะฐะผะธ**

## ๐ฏ ะัะฟะพะปัะทะพะฒะฐะฝะธะต

### API Endpoints

#### POST `/api/payments/sbp`
ะกะพะทะดะฐะฝะธะต ะฝะพะฒะพะณะพ ะกะะ ะฟะปะฐัะตะถะฐ

```typescript
// ะะฐะฟัะพั
{
  "planId": "pro",
  "planName": "ะัะพัะตััะธะพะฝะฐะปัะฝัะน",
  "amount": 599
}

// ะัะฒะตั
{
  "success": true,
  "paymentId": "2c85d245-...",
  "qrCode": "data:image/svg+xml;base64,...",
  "qrUrl": "https://qr.nspk.ru/...",
  "amount": 599,
  "currency": "RUB",
  "orderId": "adlab_1234567890_abc123",
  "status": "pending",
  "expiresAt": "2024-01-01T12:15:00.000Z"
}
```

#### GET `/api/payments/sbp?paymentId=xxx`
ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟะปะฐัะตะถะฐ

```typescript
// ะัะฒะตั
{
  "success": true,
  "paymentId": "2c85d245-...",
  "status": "completed",
  "amount": 599,
  "completedAt": "2024-01-01T12:10:00.000Z"
}
```

#### POST `/api/payments/webhook`
ะะตะฑััะบ ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน ะพั ะฎKassa (ะฐะฒัะพะผะฐัะธัะตัะบะธะน)

### Frontend ะบะพะผะฟะพะฝะตะฝัั

```typescript
import { PaywallModal } from '@/components/paywall-modal';

function MyComponent() {
  const [showPaywall, setShowPaywall] = useState(false);

  const handlePaymentSuccess = () => {
    console.log('ะะปะฐัะตะถ ััะฟะตัะฝะพ ะทะฐะฒะตััะตะฝ!');
    // ะะฑะฝะพะฒะธัั UI, ะฟัะตะดะพััะฐะฒะธัั ะดะพัััะฟ ะบ ััะฝะบัะธัะผ
  };

  return (
    <PaywallModal
      open={showPaywall}
      onOpenChange={setShowPaywall}
      onPaymentSuccess={handlePaymentSuccess}
    />
  );
}
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### ะัะพะฒะตัะบะธ ะฒ ัะธััะตะผะต

- โ **ะัะพะฒะตัะบะฐ ะฟะพะดะฟะธัะธ ะฒะตะฑััะบะพะฒ** ะดะปั ะทะฐัะธัั ะพั ะฟะพะดะดะตะปะบะธ
- โ **ะััะตะฝัะธัะธะบะฐัะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน** ัะตัะตะท JWT ัะตััะธะธ
- โ **ะะฐะปะธะดะฐัะธั ััะผะผ ะฟะปะฐัะตะถะตะน** ะฟัะพัะธะฒ ะฟะปะฐะฝะพะฒ ะฒ ะะ
- โ **Rate limiting** ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ัะฟะฐะผะฐ
- โ **ะจะธััะพะฒะฐะฝะธะต ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝัั ะดะฐะฝะฝัั**
- โ **ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะพะฟะตัะฐัะธะน** ะดะปั ะฐัะดะธัะฐ

### ะะตะบะพะผะตะฝะดะฐัะธะธ

1. **ะัะฟะพะปัะทัะนัะต HTTPS** ะฒ production
2. **ะฅัะฐะฝะธัะต ัะตะบัะตัะฝัะต ะบะปััะธ** ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
3. **ะะพะฝะธัะพัััะต ะปะพะณะธ** ะฝะฐ ะฟะพะดะพะทัะธัะตะปัะฝัั ะฐะบัะธะฒะฝะพััั
4. **ะะตะณัะปััะฝะพ ะพะฑะฝะพะฒะปัะนัะต** ะทะฐะฒะธัะธะผะพััะธ
5. **ะขะตััะธััะนัะต ะฒ sandbox** ะฟะตัะตะด production

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะะพะณะธ ะดะปั ะพััะปะตะถะธะฒะฐะฝะธั

```bash
# ะกะพะทะดะฐะฝะธะต ะฟะปะฐัะตะถะตะน
[INFO] ะกะะ ะฟะปะฐัะตะถ ััะฟะตัะฝะพ ัะพะทะดะฐะฝ: orderId=..., amount=599

# ะะฑัะฐะฑะพัะบะฐ ะฒะตะฑััะบะพะฒ
[INFO] Payment status updated: paymentId=..., oldStatus=pending, newStatus=completed

# ะัะธะฑะบะธ
[ERROR] ะฎKassa payment creation error: Invalid amount
```

### ะะตััะธะบะธ ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ

- ะะพะปะธัะตััะฒะพ ัะพะทะดะฐะฝะฝัั ะฟะปะฐัะตะถะตะน
- ะัะพัะตะฝั ััะฟะตัะฝัั ะฟะปะฐัะตะถะตะน
- ะัะตะผั ะพะฑัะฐะฑะพัะบะธ ะฟะปะฐัะตะถะตะน
- ะัะธะฑะบะธ API ะฎKassa
- ะกัะฐัััั ะฒะตะฑััะบะพะฒ

## ๐จ Troubleshooting

### ะงะฐัััะต ะฟัะพะฑะปะตะผั

#### 1. "ะฎKassa ะฝะต ะฝะฐัััะพะตะฝะฐ"
```bash
# ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
echo $YOOKASSA_SHOP_ID
echo $YOOKASSA_SECRET_KEY

# ะะฐะฟัััะธัะต ัะตัั ะฟะพะดะบะปััะตะฝะธั
npm run test:payments
```

#### 2. "ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ะฑะฐะทะต ะดะฐะฝะฝัั"
```bash
# ะัะพะฒะตัััะต DATABASE_URL
psql $DATABASE_URL -c "SELECT 1"

# ะฃะฑะตะดะธัะตัั ััะพ ัะฐะฑะปะธัั ัะพะทะดะฐะฝั
psql $DATABASE_URL -c "\dt"
```

#### 3. "QR-ะบะพะด ะฝะต ะพัะพะฑัะฐะถะฐะตััั"
- ะัะพะฒะตัััะต ััะพ `qrCode` ัะพะดะตัะถะธั ะฒะฐะปะธะดะฝัะต ะดะฐะฝะฝัะต
- ะฃะฑะตะดะธัะตัั ััะพ YooKassa ะฒะพะทะฒัะฐัะฐะตั `confirmation_data`
- ะัะพะฒะตัััะต CSP ะฟะพะปะธัะธะบะธ ะดะปั data: URLs

#### 4. "ะะตะฑััะบ ะฝะต ัะฐะฑะพัะฐะตั"
- URL ะดะพะปะถะตะฝ ะฑััั ะดะพัััะฟะตะฝ ะธะทะฒะฝะต
- ะัะพะฒะตัััะต ะฝะฐัััะพะนะบะธ ะฒ ะปะธัะฝะพะผ ะบะฐะฑะธะฝะตัะต ะฎKassa
- ะะพะณะธ ะดะพะปะถะฝั ะฟะพะบะฐะทัะฒะฐัั ะฒัะพะดััะธะต ะทะฐะฟัะพัั
- ะัะพะฒะตัััะต ะฟัะพะฒะตัะบั ะฟะพะดะฟะธัะธ ะฒะตะฑััะบะฐ

## ๐ ะะพะดะดะตัะถะบะฐ

ะัะปะธ ั ะฒะฐั ะฒะพะทะฝะธะบะปะธ ะฟัะพะฑะปะตะผั:

1. ะัะพะฒะตัััะต ะปะพะณะธ ะฟัะธะปะพะถะตะฝะธั
2. ะะฐะฟัััะธัะต ัะตัั ัะธััะตะผั: `npm run test:payments`
3. ะัะพะฒะตัััะต ััะฐััั ะฎKassa ะฝะฐ [status.yookassa.ru](https://status.yookassa.ru)
4. ะะฑัะฐัะธัะตัั ะฒ ะฟะพะดะดะตัะถะบั ะฎKassa ะฟัะธ ะฟัะพะฑะปะตะผะฐั ั API

## ๐ Roadmap

### ะะปะฐะฝั ัะฐะทะฒะธัะธั

- [ ] **ะะพะดะดะตัะถะบะฐ ะฑะฐะฝะบะพะฒัะบะธั ะบะฐัั** ัะตัะตะท ะฎKassa
- [ ] **ะะตะบัััะตะฝัะฝัะต ะฟะปะฐัะตะถะธ** ะดะปั ะฐะฒัะพะฟัะพะดะปะตะฝะธั ะฟะพะดะฟะธัะพะบ
- [ ] **ะงะฐััะธัะฝัะต ะฒะพะทะฒัะฐัั** ัะตัะตะท API
- [ ] **ะะฝะฐะปะธัะธะบะฐ ะฟะปะฐัะตะถะตะน** ะฒ ะฐะดะผะธะฝ ะฟะฐะฝะตะปะธ
- [ ] **Push ัะฒะตะดะพะผะปะตะฝะธั** ะพ ััะฐัััะฐั ะฟะปะฐัะตะถะตะน
- [ ] **Apple Pay / Google Pay** ะธะฝัะตะณัะฐัะธั
- [ ] **ะะพะดะดะตัะถะบะฐ ะบัะธะฟัะพะฒะฐะปัั** ัะตัะตะท ะฟะฐััะฝะตัะพะฒ

---

**๐ ะกะธััะตะผะฐ ะณะพัะพะฒะฐ ะบ ัะฐะฑะพัะต!** ะัะธ ะฟัะฐะฒะธะปัะฝะพะน ะฝะฐัััะพะนะบะต ะฒั ะฟะพะปััะธัะต ะฟะพะปะฝะพััะฝะบัะธะพะฝะฐะปัะฝัั ัะธััะตะผั ะกะะ ะฟะปะฐัะตะถะตะน ั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะพะฑัะฐะฑะพัะบะพะน ะธ ะพัะปะธัะฝัะผ ะฟะพะปัะทะพะฒะฐัะตะปััะบะธะผ ะพะฟััะพะผ. 